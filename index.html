<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload & Preview Dokumen Bangunan</title>
<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  /* Sticky header */
  table th { position: sticky; top: 0; background-color: #f3f3f3; z-index: 10; }
  /* Responsive for mobile */
  @media(max-width:640px){ table{display:none;} .card-list{display:block;} }
  @media(min-width:641px){ .card-list{display:none;} }
  iframe { width: 100%; height: 300px; border: 1px solid #ccc; margin-top: 4px; }
</style>
</head>
<body class="bg-gray-100 p-4">

<div class="container mx-auto">
<h1 class="text-2xl font-bold text-center mb-6">Upload & Preview Dokumen Bangunan</h1>

<div class="bg-white rounded shadow p-4 mb-6 overflow-auto">
  <input type="text" id="searchBox" placeholder="Cari..." class="form-control mb-4 w-full sm:w-64">

  <!-- Table Desktop -->
  <table class="table table-bordered table-striped table-hover">
    <thead id="tableHeader" class="table-light"></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- Mobile Card List -->
  <div id="cardList" class="card-list space-y-4"></div>
</div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz6eXRM2jRKaZVWVCnhKczbxlpXZb4u91hTHtp5yiF-l1qODeKq6IkurjlxJOuGx8t-mA/exec"; // ganti dengan URL Apps Script
let allData=[], filteredData=[], currentPage=1, rowsPerPage=10;

// Convert file to Base64
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=e=>reject(e);
    reader.readAsDataURL(file);
  });
}

// Format Rupiah
function formatRupiah(val){
  if(!val) return "";
  let num = Number(val.toString().replace(/[^0-9.-]+/g,""));
  return "Rp."+num.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2});
}

// Load data dari Sheet
async function loadData(){
  const res=await fetch(`${WEB_APP_URL}?action=getAploudData`);
  const data=await res.json();
  allData=data;
  filteredData=allData;
  currentPage=1;
  renderTable();
}

// Filter data
function applyFilters(){
  const q=document.getElementById("searchBox").value.toLowerCase();
  filteredData=allData.filter(row=>Object.values(row).some(v=>String(v).toLowerCase().includes(q)));
  currentPage=1;
  renderTable();
}

// Render table & card
function renderTable(){
  const tbody=document.getElementById("tableBody");
  const thead=document.getElementById("tableHeader");
  const cardList=document.getElementById("cardList");
  tbody.innerHTML=""; thead.innerHTML=""; cardList.innerHTML="";

  if(!filteredData.length){tbody.innerHTML="<tr><td colspan='14' class='text-center p-2'>Tidak ada data</td></tr>"; return;}

  const headers=Object.keys(filteredData[0]);
  const trh=document.createElement("tr");
  headers.forEach(h=>{const th=document.createElement("th"); th.textContent=h; trh.appendChild(th);});
  thead.appendChild(trh);

  const start=(currentPage-1)*rowsPerPage, end=start+rowsPerPage;
  const pageData=filteredData.slice(start,end);

  pageData.forEach(row=>{
    const tr=document.createElement("tr");
    headers.forEach(h=>{
      const td=document.createElement("td");
      if(h==="LINK DOKUMEN"){
        td.innerHTML=row[h] 
          ? `<a href="${row[h]}" target="_blank">üëÅÔ∏è</a>` 
          : "";
        td.innerHTML+=`<br><input type="file" onchange="uploadFile(event,'${encodeURIComponent(row['Nama Satuan'])}','${encodeURIComponent(row['Status Penggunaan'])}',this.parentNode)"/>`;
        if(row[h]) td.innerHTML+=`<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(row[h])}&embedded=true"></iframe>`;
      }else if(h==="Nilai Perolehan (Rp)"){
        td.textContent=formatRupiah(row[h]);
      }else td.textContent=row[h];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Mobile cards
  pageData.forEach(row=>{
    const card=document.createElement("div");
    card.className="border rounded-lg p-3 bg-white shadow-sm";
    let html="";
    headers.forEach(h=>{
      if(h==="LINK DOKUMEN"){
        html+=`<p>${h}: `+(row[h]? `<a href="${row[h]}" target="_blank">üëÅÔ∏è</a>`:"")+`</p>`;
        html+=`<input type="file" class="w-full mt-1" onchange="uploadFile(event,'${encodeURIComponent(row['Nama Satuan'])}','${encodeURIComponent(row['Status Penggunaan'])}',this.parentNode)"/>`;
        if(row[h]) html+=`<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(row[h])}&embedded=true"></iframe>`;
      }else if(h==="Nilai Perolehan (Rp)"){
        html+=`<p><b>${h}:</b> ${formatRupiah(row[h])}</p>`;
      }else html+=`<p><b>${h}:</b> ${row[h]}</p>`;
    });
    card.innerHTML=html;
    cardList.appendChild(card);
  });
}

// Upload file & simpan link otomatis ke kolom M
async function uploadFile(e,namaSatuan,status,container){
  const file=e.target.files[0]; if(!file) return;
  const statusMsg=document.createElement("p"); statusMsg.textContent="Mengunggah..."; container.appendChild(statusMsg);
  const base64=await fileToBase64(file);
  const payload={action:"uploadFile",namaSatuan:decodeURIComponent(namaSatuan),statusPenggunaan:decodeURIComponent(status),base64:base64.split(",")[1],mimeType:file.type};
  const res=await fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify(payload)});
  const result=await res.json();
  if(result.success){
    statusMsg.textContent="Upload berhasil!";
    e.target.disabled=true;
    const iframe=document.createElement("iframe");
    iframe.src=`https://docs.google.com/gview?url=${encodeURIComponent(result.fileUrl)}&embedded=true`;
    container.appendChild(iframe);
  }else statusMsg.textContent="Gagal upload: "+result.message;
}

document.getElementById("searchBox").addEventListener("input",applyFilters);
window.addEventListener("DOMContentLoaded",loadData);
</script>

</body>
</html>
