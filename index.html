<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Dokumen Pendukung</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold text-center mb-6">Upload Dokumen Pendukung Inventarisasi</h1>

  <div class="overflow-x-auto bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
      <input type="text" id="searchBox" placeholder="Cari..." class="border rounded p-2 w-full sm:w-64">
    </div>

    <table class="table-auto w-full border-collapse border border-gray-300 text-sm">
      <thead class="bg-gray-200 sticky top-0">
        <tr id="tableHeader"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div class="flex justify-center items-center gap-2 mt-4">
      <button id="prevBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Prev</button>
      <span id="pageInfo" class="text-sm"></span>
      <button id="nextBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Next</button>
    </div>
  </div>

<script>
const WEB_APP_URL = "YOUR_WEB_APP_URL_HERE"; // ganti dengan URL Apps Script
let allData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 10;

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = e => reject(e);
    reader.readAsDataURL(file);
  });
}

async function loadData() {
  try {
    const res = await fetch(`${WEB_APP_URL}?action=getAploudData`);
    const data = await res.json();
    allData = data;
    filteredData = allData;
    renderTable();
  } catch (err) {
    console.error(err);
    alert("Gagal load data.");
  }
}

function applyFilters() {
  const q = document.getElementById("searchBox").value.toLowerCase();
  filteredData = allData.filter(row => 
    Object.values(row).some(v => String(v).toLowerCase().includes(q))
  );
  currentPage = 1;
  renderTable();
}

function renderTable() {
  const tbody = document.getElementById("tableBody");
  const thead = document.getElementById("tableHeader");
  tbody.innerHTML = "";
  thead.innerHTML = "";

  if (!filteredData.length) {
    tbody.innerHTML = "<tr><td colspan='14' class='text-center p-2'>Tidak ada data</td></tr>";
    return;
  }

  // buat header
  const headers = Object.keys(filteredData[0]);
  headers.forEach(h => {
    const th = document.createElement("th");
    th.className = "border p-2";
    th.textContent = h;
    thead.appendChild(th);
  });

  // pagination
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  pageData.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      td.className = "border p-2";

      if (h === "LINK DOKUMEN") {
        if (row[h]) {
          td.innerHTML = `<a href="${row[h]}" target="_blank" class="text-blue-600 underline">Lihat</a><br>`;
        }
        td.innerHTML += `
          <input type="file" class="text-xs mt-1" onchange="uploadFile(event, '${encodeURIComponent(row['Nama Satuan'])}', '${encodeURIComponent(row['Status Penggunaan'])}')"
            ${row[h] ? "disabled" : ""}/>
          ${row[h] ? "<p class='text-xs text-green-600 mt-1'>Sudah upload</p>" : ""}
        `;
      } else {
        td.textContent = row[h];
      }

      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // update pagination info
  const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
  document.getElementById("pageInfo").textContent = `Halaman ${currentPage} dari ${totalPages}`;
  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = currentPage === totalPages;
}

async function uploadFile(e, namaSatuan, status) {
  const file = e.target.files[0];
  if (!file) return;
  const statusMsg = document.createElement("p");
  statusMsg.textContent = "Mengunggah...";
  statusMsg.className = "text-xs mt-1 text-gray-600";
  e.target.parentNode.appendChild(statusMsg);

  try {
    const base64 = await fileToBase64(file);
    const payload = {
      action: "uploadFile",
      namaSatuan: decodeURIComponent(namaSatuan),
      statusPenggunaan: decodeURIComponent(status),
      base64: base64.split(",")[1],
      mimeType: file.type
    };

    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (result.success) {
      statusMsg.textContent = "Upload berhasil!";
      e.target.disabled = true;
      // update link di tabel secara langsung
      loadData();
    } else {
      statusMsg.textContent = "Gagal upload: " + result.message;
    }
  } catch (err) {
    console.error(err);
    statusMsg.textContent = "Terjadi kesalahan saat upload.";
  }
}

document.getElementById("searchBox").addEventListener("input", applyFilters);
document.getElementById("prevBtn").addEventListener("click", () => { if (currentPage>1){currentPage--; renderTable();} });
document.getElementById("nextBtn").addEventListener("click", () => { const totalPages=Math.ceil(filteredData.length/rowsPerPage); if(currentPage<totalPages){currentPage++; renderTable();} });

window.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
