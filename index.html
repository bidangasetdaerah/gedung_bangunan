<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload & Preview Dokumen Bangunan</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  table th { position: sticky; top: 0; background-color: #f3f3f3; z-index: 10; }
  @media(max-width:640px){ table{display:none;} .card-list{display:block;} }
  @media(min-width:641px){ .card-list{display:none;} }
  .doc-icon { font-size: 20px; cursor:pointer; margin-right:4px; }
</style>
</head>
<body class="bg-gray-100 p-4">

<div class="container mx-auto">
<h1 class="text-2xl font-bold text-center mb-6">Upload & Preview Dokumen Bangunan</h1>

<div class="bg-white rounded shadow p-4 mb-6 overflow-auto">
  <input type="text" id="searchBox" placeholder="Cari..." class="form-control mb-4 w-full sm:w-64">

  <table class="table table-bordered table-striped table-hover">
    <thead id="tableHeader" class="table-light"></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="cardList" class="card-list space-y-4"></div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyYqV4CpGFMZR1dTeEz8ohfqC5j2_X11V7Mkr8kSHaf_3AwIhx0LOWRbWDEWpBvI1bZ/exec"; // ganti URL Apps Script
let allData=[], filteredData=[], currentPage=1, rowsPerPage=10;

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=e=>reject(e);
    reader.readAsDataURL(file);
  });
}

// Format Rupiah
function formatRupiah(val){
  if(!val) return "";
  let num = Number(val.toString().replace(/[^0-9.-]+/g,""));
  return "Rp."+num.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2});
}

// Load data dari spreadsheet
async function loadData(){
  try{
    const res = await fetch(`${WEB_APP_URL}?action=getAploudData`);
    const data = await res.json();
    allData = data;
    filteredData = allData;
    currentPage = 1;
    renderTable();
  }catch(err){
    console.error(err);
    alert("Gagal load data");
  }
}

function applyFilters(){
  const q = document.getElementById("searchBox").value.toLowerCase();
  filteredData = allData.filter(row => Object.values(row).some(v=>String(v).toLowerCase().includes(q)));
  currentPage = 1;
  renderTable();
}

function renderTable(){
  const tbody = document.getElementById("tableBody");
  const thead = document.getElementById("tableHeader");
  const cardList = document.getElementById("cardList");
  tbody.innerHTML=""; thead.innerHTML=""; cardList.innerHTML="";

  if(!filteredData.length){
    tbody.innerHTML="<tr><td colspan='14' class='text-center p-2'>Tidak ada data</td></tr>"; 
    return;
  }

  const headers = Object.keys(filteredData[0]);
  const trh = document.createElement("tr");
  headers.forEach(h=>{
    const th = document.createElement("th");
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  filteredData.forEach(row=>{
    const tr = document.createElement("tr");
    headers.forEach(h=>{
      const td = document.createElement("td");
      if(h === "LINK DOKUMEN"){
        td.innerHTML = "";
        if(row[h]) td.innerHTML = `<a href="${row[h]}" target="_blank" class="doc-icon">ðŸ“–</a>`;
        td.innerHTML += `<br><input type="file" class="w-full mt-1" onchange="uploadFile(event,'${encodeURIComponent(row['Nama Barang'])}','${encodeURIComponent(row['Status Penggunaan'])}',this.parentNode)"/>`;
      } else if(h==="Nilai Perolehan (Rp)"){
        td.textContent = formatRupiah(row[h]);
      } else {
        td.textContent = row[h];
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Card view mobile
  filteredData.forEach(row=>{
    const card = document.createElement("div");
    card.className = "border rounded-lg p-3 bg-white shadow-sm";
    let html="";
    headers.forEach(h=>{
      if(h === "LINK DOKUMEN"){
        html += `<p>${h}: `;
        if(row[h]) html += `<a href="${row[h]}" target="_blank" class="doc-icon">ðŸ“–</a>`;
        html += `</p><input type="file" class="w-full mt-1" onchange="uploadFile(event,'${encodeURIComponent(row['Nama Barang'])}','${encodeURIComponent(row['Status Penggunaan'])}',this.parentNode)"/>`;
      } else if(h==="Nilai Perolehan (Rp)"){
        html += `<p><b>${h}:</b> ${formatRupiah(row[h])}</p>`;
      } else {
        html += `<p><b>${h}:</b> ${row[h]}</p>`;
      }
    });
    card.innerHTML = html;
    cardList.appendChild(card);
  });
}

// Upload file ke Drive & update spreadsheet
async function uploadFile(e,namaBarang,status,container){
  const file = e.target.files[0]; if(!file) return;
  const statusMsg = document.createElement("p"); statusMsg.textContent="Mengunggah..."; container.appendChild(statusMsg);

  try{
    const base64 = await fileToBase64(file);
    const payload = {
      action: "uploadFile",
      namaBarang: decodeURIComponent(namaBarang),
      statusPenggunaan: decodeURIComponent(status),
      base64: base64.split(",")[1],
      mimeType: file.type
    };
    const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();
    if(result.success){
      statusMsg.textContent="Upload berhasil!";
      e.target.disabled = true;

      const docIcon = document.createElement("a");
      docIcon.href = result.fileUrl;
      docIcon.target = "_blank";
      docIcon.className = "doc-icon";
      docIcon.textContent = "ðŸ“–";
      container.insertBefore(docIcon, container.firstChild);
    } else statusMsg.textContent="Gagal upload: "+result.message;
  } catch(err){
    console.error(err);
    statusMsg.textContent="Terjadi kesalahan saat upload.";
  }
}

document.getElementById("searchBox").addEventListener("input",applyFilters);
window.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>
