<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload & Preview Dokumen Bangunan</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @media (max-width: 640px) {
    table { display: none; }
    .card-list { display: block; }
  }
  @media (min-width: 641px) {
    .card-list { display: none; }
  }
  .modal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.6);
    justify-content:center;
    align-items:center;
    z-index:50;
  }
  .modal-content {
    width:90%; max-width:900px; height:80%;
    background:white; border-radius:8px; overflow:hidden; display:flex; flex-direction:column;
  }
  .modal-close {
    cursor:pointer;
  }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
<h1 class="text-2xl font-bold text-center mb-6">Upload & Preview Dokumen Bangunan</h1>

<div class="overflow-x-auto bg-white p-4 rounded shadow mb-6">
  <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
    <input type="text" id="searchBox" placeholder="Cari..." class="border rounded p-2 w-full sm:w-64">
  </div>

  <!-- Tabel Desktop -->
  <table class="table-auto w-full border-collapse border border-gray-300 text-sm">
    <thead class="bg-gray-200 sticky top-0" id="tableHeader"></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- Card List Mobile -->
  <div id="cardList" class="card-list space-y-4"></div>

  <!-- Pagination -->
  <div class="flex justify-center items-center gap-2 mt-4">
    <button id="prevBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Prev</button>
    <span id="pageInfo" class="text-sm"></span>
    <button id="nextBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Next</button>
  </div>
</div>

<!-- Modal Preview -->
<div id="modalPreview" class="modal flex">
  <div class="modal-content">
    <div class="flex justify-between items-center p-2 border-b">
      <span class="font-bold">Preview Dokumen</span>
      <a id="downloadBtn" href="#" target="_blank" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">Download</a>
      <span id="closeModal" class="modal-close text-xl ml-2">&times;</span>
    </div>
    <iframe id="previewFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby5jT3um6XdAKpzey2Jn6Mq2V9obZhRx8TF1R8iU-ZiNEx9urtQeSTUM9rAiiGF2hS4qw/exec"; // Ganti dengan URL deploy Apps Script
let allData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;

// Convert file to Base64
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = e=>reject(e);
    reader.readAsDataURL(file);
  });
}

// Load data dari Sheet
async function loadData(){
  try{
    const res = await fetch(`${WEB_APP_URL}?action=getAploudData`);
    const data = await res.json();
    allData = data;
    filteredData = allData;
    currentPage = 1;
    renderTable();
  }catch(err){
    console.error(err);
    alert("Gagal load data.");
  }
}

// Filter data berdasarkan pencarian
function applyFilters(){
  const q = document.getElementById("searchBox").value.toLowerCase();
  filteredData = allData.filter(row =>
    Object.values(row).some(v=>String(v).toLowerCase().includes(q))
  );
  currentPage = 1;
  renderTable();
}

// Render tabel dan card
function renderTable(){
  const tbody=document.getElementById("tableBody");
  const thead=document.getElementById("tableHeader");
  const cardList=document.getElementById("cardList");
  tbody.innerHTML=""; thead.innerHTML=""; cardList.innerHTML="";

  if(!filteredData.length){
    tbody.innerHTML="<tr><td colspan='14' class='text-center p-2'>Tidak ada data</td></tr>";
    return;
  }

  const headers = Object.keys(filteredData[0]);
  // Header desktop
  const trh=document.createElement("tr");
  headers.forEach(h=>{
    const th=document.createElement("th");
    th.className="border p-2";
    th.textContent=h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  const start=(currentPage-1)*rowsPerPage;
  const end=start+rowsPerPage;
  const pageData=filteredData.slice(start,end);

  // Desktop Table
  pageData.forEach(row=>{
    const tr=document.createElement("tr");
    headers.forEach(h=>{
      const td=document.createElement("td");
      td.className="border p-2";
      if(h==="LINK DOKUMEN"){
        td.innerHTML = row[h] 
          ? `<a href="#" onclick="previewFile('${row[h]}')" title="Lihat Dokumen">üëÅÔ∏è</a>` 
          : "";
        td.innerHTML+=`<br>
          <input type="file" class="text-xs mt-1" onchange="uploadFile(event,'${encodeURIComponent(row['Nama Satuan'])}','${encodeURIComponent(row['Status Penggunaan'])}')"
          ${row[h]?"disabled":""}/>
          ${row[h]? "<p class='text-xs text-green-600 mt-1'>Sudah upload</p>":""}`;
      } else td.textContent=row[h];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Mobile cards
  pageData.forEach(row=>{
    const card=document.createElement("div");
    card.className="border rounded-lg p-3 bg-white shadow-sm";
    let html="";
    headers.forEach(h=>{
      if(h==="LINK DOKUMEN"){
        html+=`<p>${h}: `;
        if(row[h]) html+=`<a href="#" onclick="previewFile('${row[h]}')" title="Lihat Dokumen">üëÅÔ∏è</a>`;
        html+=`</p>
          <input type="file" class="text-xs mt-1 w-full" onchange="uploadFile(event,'${encodeURIComponent(row['Nama Satuan'])}','${encodeURIComponent(row['Status Penggunaan'])}')"
          ${row[h]?"disabled":""}/>
          ${row[h]? "<p class='text-xs text-green-600 mt-1'>Sudah upload</p>":""}`;
      } else html+=`<p><b>${h}:</b> ${row[h]}</p>`;
    });
    card.innerHTML=html;
    cardList.appendChild(card);
  });

  // Pagination info
  const totalPages=Math.ceil(filteredData.length/rowsPerPage)||1;
  document.getElementById("pageInfo").textContent=`Halaman ${currentPage} dari ${totalPages}`;
  document.getElementById("prevBtn").disabled=currentPage===1;
  document.getElementById("nextBtn").disabled=currentPage===totalPages;
}

// Upload file
async function uploadFile(e,namaSatuan,status){
  const file=e.target.files[0];
  if(!file) return;
  const statusMsg=document.createElement("p");
  statusMsg.textContent="Mengunggah...";
  statusMsg.className="text-xs mt-1 text-gray-600";
  e.target.parentNode.appendChild(statusMsg);

  try{
    const base64=await fileToBase64(file);
    const payload={
      action:"uploadFile",
      namaSatuan:decodeURIComponent(namaSatuan),
      statusPenggunaan:decodeURIComponent(status),
      base64:base64.split(",")[1],
      mimeType:file.type
    };
    const res=await fetch(WEB_APP_URL,{
      method:"POST",
      body:JSON.stringify(payload)
    });
    const result=await res.json();
    if(result.success){
      statusMsg.textContent="Upload berhasil!";
      e.target.disabled=true;
      loadData(); // refresh agar link muncul
    }else{
      statusMsg.textContent="Gagal upload: "+result.message;
    }
  }catch(err){
    console.error(err);
    statusMsg.textContent="Terjadi kesalahan saat upload.";
  }
}

// Preview file PDF/Word
function previewFile(url){
  const modal=document.getElementById("modalPreview");
  const frame=document.getElementById("previewFrame");
  const downloadBtn=document.getElementById("downloadBtn");
  modal.style.display="flex";
  frame.src=`https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true`;
  downloadBtn.href=url;
}

// Close modal
document.getElementById("closeModal").addEventListener("click",()=>{
  document.getElementById("modalPreview").style.display="none";
  document.getElementById("previewFrame").src="";
});

// Event listeners
document.getElementById("searchBox").addEventListener("input",applyFilters);
document.getElementById("prevBtn").addEventListener("click",()=>{if(currentPage>1){currentPage--; renderTable();}});
document.getElementById("nextBtn").addEventListener("click",()=>{const totalPages=Math.ceil(filteredData.length/rowsPerPage); if(currentPage<totalPages){currentPage++; renderTable();}});

window.addEventListener("DOMContentLoaded",loadData);
</script>
</body>
</html>
